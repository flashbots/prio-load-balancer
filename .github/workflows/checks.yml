on: [push, pull_request]
name: Checks
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: ^1.19
      id: go

    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@latest

    - name: Lint
      run: make lint

    - name: Ensure go mod tidy runs without changes
      run: |
        go mod tidy
        git diff-index HEAD
        git diff-index --quiet HEAD

  test:
    runs-on: ubuntu-jammy
    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: ^1.19
      id: go


    - name: add intel SGX repository and packages
      uses: myci-actions/add-deb-repo@10
      with:
        repo: deb [arch=amd64] https://download.01.org/intel-sgx/sgx_repo/ubuntu jammy main
        repo-name: intel-sgx
        keys-asc: https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key
        install: libsgx-urts

    - name: add gramine repository and packages
      uses: myci-actions/add-deb-repo@10
      with:
        repo: deb [arch=amd64] https://packages.gramineproject.io/ jammy main
        repo-name: gramine
        keys-asc: https://packages.gramineproject.io/gramine-keyring.gpg
        install: gramine

    - name: Checkout code
      uses: actions/checkout@v2

    - name: Test
      run: make test
